#!/bin/bash 

source config.sh
source fonction.sh

echo "
*************************************************************************************
*************************************************************************************
********************************Test de la config reseau sur www.google.fr***********
*************************************************************************************
*************************************************************************************
"
ping -c 3 www.google.fr > /dev/null

if [[ $? -eq 0 ]]; then
    echo -e "${valid}
*************************************************************************************
********************************Config reseau OK !***********************************
*************************************************************************************${blanc}
"
else
    echo -e "${erreur}
*************************************************************************************
********************************Erreur dans la config reseau*************************
*************************************************************************************${blanc}
"
    exit 1
fi

echo "
*************************************************************************************
*************************************************************************************
********************************Installation de OpenSSH Server***********************
*************************************************************************************
*************************************************************************************
"

apt update > /dev/null

apt install -y openssh-server

read -p "Configurer un port spécifique ? (o/n) " port
while [ "$port" != "o" ] && [ "$port" != "n" ]; do
    echo "Saisie incorrecte."
    read -p "Configurer un port spécifique ? (o/n) " port
done
if [[ $port == "o" ]]; then
	read -p "Quel port spécifique ? " nport
    sed -i "s/^#\?Port .*/Port $nport/" /etc/ssh/sshd_config
else
    nport=22
fi

read -p "Authoriser la connexion root ? (o/n) " root
while [ "$root" != "o" ] && [ "$root" != "n" ]; do
    echo "Saisie incorrecte."
    read -p "Authoriser la connexion root ? (o/n) " root
done
if [[ $root == "o" ]]; then
    sed -i "s/^#\?PermitRootLogin .*/PermitRootLogin yes/" /etc/ssh/sshd_config
else
    sed -i "s/^#\?PermitRootLogin .*/PermitRootLogin no/" /etc/ssh/sshd_config
fi

systemctl restart sshd
if [[ $? -eq 0 ]]; then
    echo -e "${valid}
*************************************************************************************
*************************************************************************************
********************************Installation réussite********************************
*************************************************************************************
*************************************************************************************${blanc}

******************************************************
Connectez-vous à cette IP sur le poste client : ${valid}$(ip a|grep brd|grep inet|tr " " "-"|cut -d "-" -f 6)${blanc} ******
******************************************************



*************************************
Le numéro de port est le $nport 
*************************************

"
else
    echo -e "${erreur}
*************************************************************************************
*************************************************************************************
********************************Erreur lors de l'installation************************
*************************************************************************************
*************************************************************************************${blanc}
"
fi

echo "[Appuyer sur entrer pour continuer]"
read