#!/bin/bash 

source config.sh
source fonction.sh

echo "
*************************************************************************************
*************************************************************************************
********************************Test de la config reseau sur www.google.fr***********
*************************************************************************************
*************************************************************************************
"
ping -c 3 www.google.fr > /dev/null

if [[ $? -eq 0 ]]; then
    echo -e "${valid}
*************************************************************************************
********************************Config reseau OK !***********************************
*************************************************************************************${blanc}
"
else
    echo -e "${erreur}
*************************************************************************************
********************************Erreur dans la config reseau*************************
*************************************************************************************${blanc}
"
    exit 1
fi

echo "
*************************************************************************************
*************************************************************************************
********************************Installation de Samba********************************
*************************************************************************************
*************************************************************************************
"

apt update > /dev/null
apt install samba -y

cp /etc/samba/smb.conf /etc/samba/smb.conf.backup

read -p "Configurer un chemin spécifique ? (o/n) " rep
while [ "$rep" != "o" ] && [ "$rep" != "n" ]; do
    echo "Saisie incorrecte."
    read -p "Configurer un chemin spécifique ? (o/n) " rep
done
if [[ $rep == "o" ]]; then
    read -p "Donnez le chemin complet de vôtre partage : " chemin
    read -p "Donnez le dossier de vôtre partage : " dossier
else
    chemin="/srv/samba/partage"
    dossier=partage
fi

read -p "Restreindre avec des users ? (o/n) " restriction
while [ "$restriction" != "o" ] && [ "$restriction" != "n" ]; do
    echo "Saisie incorrecte."
    read -p "Restreindre avec des users ? (o/n) " restriction
done
if [[ $restriction == "o" ]]; then
    read -p "Donnez les users PAM séparé par des espaces : " users
    a="valid users = $users
directory mask = 2770
create mask = 0660"
else 
    a=""
fi

mkdir -p "$chemin"
chown nobody:nogroup "$chemin"
sudo chmod 774 "$chemin"

echo "
*************************************************************************************
*************************************************************************************
********************************Configuration du Samba*******************************
*************************************************************************************
*************************************************************************************
"

echo "
[$dossier]
path = $chemin
browseable = yes
writable = yes
guest ok = yes
read only = no
$a" >> /etc/samba/smb.conf

systemctl restart smbd nmbd

if [[ $? -eq 0 ]]; then
    echo -e "${valid}
*************************************************************************************
*************************************************************************************
********************************Installation réussite********************************
*************************************************************************************
*************************************************************************************${blanc}

******************************************************
Connectez-vous à cette IP sur le poste client : ${valid}$(ip a|grep brd|grep inet|tr " " "-"|cut -d "-" -f 6)\'$dossier'${blanc} ******
******************************************************

"
else
    echo -e "${erreur}
*************************************************************************************
*************************************************************************************
********************************Erreur lors de l'installation************************
*************************************************************************************
*************************************************************************************${blanc}
"
fi

echo "[Appuyer sur entrer pour continuer]"
read


