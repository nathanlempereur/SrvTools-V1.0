#!/bin/bash

source config.sh
source fonction.sh

echo "
*************************************************************************************
*************************************************************************************
********************************Test de la config reseau sur www.google.fr***********
*************************************************************************************
*************************************************************************************
"
ping -c 3 www.google.fr > /dev/null

if [[ $? -eq 0 ]]; then
    echo -e "${valid}
*************************************************************************************
********************************Config reseau OK !***********************************
*************************************************************************************${blanc}
"
else
    echo -e "${erreur}
*************************************************************************************
********************************Erreur dans la config reseau*************************
*************************************************************************************${blanc}
"
    exit 1
fi


echo "
*************************************************************************************
*************************************************************************************
********************************Installation de Pure-ftpd****************************
*************************************************************************************
*************************************************************************************
"


apt update > /dev/null

apt install -y pure-ftpd expect 

groupadd --gid 6262 ftpGroup

if ! id "ftp" &>/dev/null; then
	useradd -u 6262 -g ftpGroup -d /dev/null -s /bin/false ftp
fi

if [[ ! -d /home/FTP ]]; then
	mkdir /home/FTP
fi

ln -s /etc/pure-ftpd/conf/PureDB /etc/pure-ftpd/auth/75purepdb

echo no > /etc/pure-ftpd/conf/PAMAuthentication
echo no > /etc/pure-ftpd/conf/UnixAuthentication
echo yes > /etc/pure-ftpd/conf/CreateHomeDir

echo "
*************************************************************************************
*************************************************************************************
********************************Création des utilisateurs ***************************
*************************************************************************************
*************************************************************************************
*************************************************************************************"

fin=0

if [[ ! -f services/FTPvirtuel/User.csv ]]; then
		touch services/FTPvirtuel/User.csv
fi

while [ "$fin" != 1 ]; do
	read -p "Saisir le login de l'user : " Login
	read -s -p "Saisir le mot de passe : " Mdp
	echo ""
	echo "$Login $Mdp /home/FTP/"$Login"" >> services/FTPvirtuel/User.csv
	
	read -p "Encore des utilisateurs ? (o/n) : " encore
	while [ "$encore" != "o" ] && [ "$encore" != "n" ]; do
    	echo "Saisie incorrecte."
    	read -p "Encore des utilisateurs ? (o/n) : " encore
	done
	if [[ $encore == "n" ]]; then
		fin=1
	fi
done


echo "
*************************************************************************************
*************************************************************************************
********************************NE TOUCHEZ A RIEN !!!********************************
*************************************************************************************
*************************************************************************************
"

cat services/FTPvirtuel/User.csv | while read LOGIN MDP DIR  
do
	services/FTPvirtuel/./CreeUtilisateur.expect $LOGIN $MDP $DIR
done

systemctl restart pure-ftpd

if [[ $? -eq 0 ]]; then
    echo -e "${valid}
*************************************************************************************
*************************************************************************************
********************************Installation réussite********************************
*************************************************************************************
*************************************************************************************${blanc}
"
else
    echo -e "${erreur}
*************************************************************************************
*************************************************************************************
********************************Erreur lors de l'installation************************
*************************************************************************************
*************************************************************************************${blanc}
"
fi

echo "[Appuyer sur entrer pour continuer]"
read
